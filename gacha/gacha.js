const pool = {
  common: [
    'common/20220619_152715.jpg',
    'common/20220623_205448.jpg',
    'common/20220626_143344.jpg',
    'common/20220703_111044-PHOTO_FRAME.jpg',
    'common/20220910_212739(0).jpg',
    'common/20221001_172939.jpg',
    'common/20221117_122114.jpg',
    'common/20221126_170242.jpg',
    'common/20221209_223120.jpg',
    'common/20221218_205601.jpg',
    'common/20221227_135743.jpg',
    'common/20221231_190019.jpg',
    'common/20221231_200516.jpg',
    'common/20230226_223238.jpg',
    'common/20230422_133250.jpg',
    'common/20230506_124005.jpg',
    'common/20230513_124538.jpg',
    'common/20230513_125857.jpg',
    'common/20230702_152017.jpg',
    'common/20230714_195550.jpg',
    'common/20230819_113158.jpg',
    'common/20230917_092434.jpg',
    'common/20231007_140027.jpg',
    'common/20231007_162856.jpg',
    'common/20231112_140930.jpg',
    'common/20231224_181558.jpg',
    'common/20231226_091042.jpg',
    'common/20240106_171358.jpg',
    'common/20240214_205606.jpg',
    'common/20240329_145949(0).jpg',
    'common/20240413_191409.jpg',
    'common/20240420_205000.jpg',
    'common/20240518_211758.jpg',
    'common/20240608_111419.jpg',
    'common/20240707_164857(0).jpg',
    'common/20240713_194012.jpg',
    'common/20240825_130740.jpg',
    'common/20241009_214613.jpg',
    'common/20241115_202925.jpg',
    'common/20241214_173839.jpg',
    'common/20241215_115728.jpg',
    'common/20241218_164213.jpg',
    'common/20241222_111750.jpg',
    'common/20241227_153338.jpg',
    'common/20250214_191926.jpg',
    'common/20250301_190214.jpg',
    'common/20250308_182723.jpg',
    'common/20250402_191533.jpg',
    'common/20250427_120836.jpg',
    'common/20250601_103944.jpg',
    'common/20250601_193341.jpg',
    'common/SmartSelect_20220929_235159_Gallery.jpg'
  ],
  rare:   [
    'rare/20220624_202719.jpg',
    'rare/20220625_195914(0).jpg',
    'rare/20220910_212737.jpg',
    'rare/20221001_171412.jpg',
    'rare/20221001_172413.jpg',
    'rare/20221021_200832.jpg',
    'rare/20221120_150837~2.jpg',
    'rare/20221126_175946.jpg',
    'rare/20221218_224814.jpg',
    'rare/20221225_123533.jpg',
    'rare/20230402_141816.jpg',
    'rare/20230402_160443.jpg',
    'rare/20230503_204423.jpg',
    'rare/20230513_132255.jpg',
    'rare/20230730_182602.jpg',
    'rare/20230917_092532.jpg',
    'rare/20231007_161541.jpg',
    'rare/20231027_225558.jpg',
    'rare/20240221_195920.jpg',
    'rare/20240327_185053.jpg',
    'rare/20240330_144021.jpg',
    'rare/20240408_133837.jpg',
    'rare/20240420_204836.jpg',
    'rare/20240616_152345.jpg',
    'rare/20240707_164834.jpg',
    'rare/20240713_213953.jpg',
    'rare/20240728_171735.jpg',
    'rare/20241215_152503.jpg',
    'rare/20241218_132522.jpg',
    'rare/20241218_133609.jpg',
    'rare/20241219_110849.jpg',
    'rare/20250211_105938.jpg',
    'rare/20250211_193453.jpg',
    'rare/20250531_154957.jpg',
    'rare/20250709_200357.jpg',
    'rare/VideoCapture_20221001-162046.jpg'
  ],
  ultra:  [
    'ultra-rare/20220212_222014.jpg',
    'ultra-rare/20220603_205817.jpg',
    'ultra-rare/20220623_105511.jpg',
    'ultra-rare/20220625_110849.jpg',
    'ultra-rare/20220826_084622.jpg',
    'ultra-rare/20220922_222224.jpg',
    'ultra-rare/20221001_171325.jpg',
    'ultra-rare/20221022_141716.jpg',
    'ultra-rare/20221103_132334-EDIT.jpg',
    'ultra-rare/20221121_115630.jpg',
    'ultra-rare/20221130_145915.jpg',
    'ultra-rare/20221209_233201.jpg',
    'ultra-rare/20221224_173726.jpg',
    'ultra-rare/20230128_184843.jpg',
    'ultra-rare/20230226_184546(0).jpg',
    'ultra-rare/20230228_173758.jpg',
    'ultra-rare/20230402_141548-COLLAGE.jpg',
    'ultra-rare/20230421_113519.jpg',
    'ultra-rare/20230513_125015.jpg',
    'ultra-rare/20230513_132758.jpg',
    'ultra-rare/20230513_133817.jpg',
    'ultra-rare/20231007_140008.jpg',
    'ultra-rare/20231027_202217.jpg',
    'ultra-rare/20240117_090036.jpg',
    'ultra-rare/20240205_191342.jpg',
    'ultra-rare/20240327_132739.jpg',
    'ultra-rare/20240329_142705.jpg',
    'ultra-rare/20241218_173249.jpg',
    'ultra-rare/20250211_105929.jpg',
    'ultra-rare/20250211_193346.jpg',
    'ultra-rare/20250419_090529.jpg',
    'ultra-rare/20250531_154932.jpg',
    'ultra-rare/20250628_195730.jpg',
    'ultra-rare/20250628_195752.jpg',
    'ultra-rare/IMG-20220801-WA0000.jpg',
    'ultra-rare/SmartSelect_20221012_094159_Instagram.jpg',
    'ultra-rare/Snapchat-1566377080.jpg'
  ],
  legendary: [
    'legendary/20221101_165655.jpg',
    'legendary/20230716_145546.jpg',
    'legendary/20231111_160707.jpg',
    'legendary/20241218_131520~2.jpg',
    'legendary/20250211_105947.jpg',
    'legendary/20250628_195814.jpg',
    'legendary/COLOR_POP.jpg',
    'legendary/IMG-20220804-WA0001.jpg',
    'legendary/SmartSelect_20220426-165803_Snapchat.jpg',
    'legendary/SmartSelect_20220929_235130_Gallery.jpg'
  ]
};


// === Gacha Logic (localized + weighted odds + no immediate repeat + album toggle) ===

// Base path (relative to gacha.html)
const IMAGES_BASE = "images/";

// Pool sizes
const counts = {
  common: pool.common.length,
  rare: pool.rare.length,
  ultra: pool.ultra.length,
  legendary: pool.legendary.length
};

// Weight-based odds (tune these to taste)
// Larger weight => more likely relative to its pool size
const weights = {
  common: 1.00,
  rare: 0.40,
  ultra: 0.15,
  legendary: 0.08
};

// Compute weighted draw rates from (count * weight)
const weighted = {
  common: counts.common * weights.common,
  rare: counts.rare * weights.rare,
  ultra: counts.ultra * weights.ultra,
  legendary: counts.legendary * weights.legendary
};
const weightSum = Object.values(weighted).reduce((a,b)=>a+b, 0) || 1;
const drawRates = {
  common: weighted.common / weightSum,
  rare: weighted.rare / weightSum,
  ultra: weighted.ultra / weightSum,
  legendary: weighted.legendary / weightSum
};

// i18n helpers
function getLang() {
  return document.documentElement.getAttribute('data-lang') || 'en';
}
const rarityI18N = {
  en: { common: "Common", rare: "Rare", ultra: "Ultra Rare", legendary: "Legendary" },
  es: { common: "ComÃºn",  rare: "Raro", ultra: "Ultra raro", legendary: "Legendario" }
};

function setRarityLabel(rarity) {
  const el = document.getElementById("rarityLabel");
  if (!el) return;
  const lang = getLang();
  el.textContent = rarityI18N[lang][rarity] || rarity;
}

// Tracker (localized)
const trackerTextEl = document.getElementById("trackerText");
const unlocked = new Set();
const totalCount = counts.common + counts.rare + counts.ultra + counts.legendary;

function updateTracker() {
  if (!trackerTextEl) return;
  const lang = getLang();
  const n = unlocked.size;
  trackerTextEl.textContent = (lang === "es")
    ? `Descubiertas ${n} de ${totalCount} memorias`
    : `Unlocked ${n} of ${totalCount} memories`;
}

// React to language changes
new MutationObserver((muts) => {
  for (const m of muts) {
    if (m.type === "attributes" && m.attributeName === "data-lang") {
      updateTracker();
    }
  }
}).observe(document.documentElement, { attributes: true });

// No immediate repeat
let lastImagePath = null;

function pickRarity() {
  const roll = Math.random();
  let cum = 0;
  for (const rarity of ["common", "rare", "ultra", "legendary"]) {
    cum += drawRates[rarity];
    if (roll < cum) return rarity;
  }
  return "common";
}

function drawOnce() {
  const rarity = pickRarity();
  const poolArr = pool[rarity];
  if (!poolArr || poolArr.length === 0) {
    return { rarity: "common", imagePath: null };
  }
  // Avoid immediate repeat
  let choice = null;
  const maxTries = Math.min(10, poolArr.length);
  for (let i = 0; i < maxTries; i++) {
    const candidate = poolArr[Math.floor(Math.random() * poolArr.length)];
    if (candidate !== lastImagePath) { choice = candidate; break; }
  }
  if (!choice) choice = poolArr[Math.floor(Math.random() * poolArr.length)];
  lastImagePath = choice;
  return { rarity, imagePath: IMAGES_BASE + choice };
}

function onDraw() {
  const { rarity, imagePath } = drawOnce();
  if (!imagePath) return;

  // Update rarity label (localized)
  setRarityLabel(rarity);

  // Reveal card + image
  const resultCard = document.getElementById("resultCard");
  const photoCard = document.getElementById("photoCard");
  if (photoCard) photoCard.src = imagePath;
  if (resultCard) resultCard.classList.remove("hidden");

  // Track unlocks and update tracker
  const wasNew = !unlocked.has(imagePath);
  unlocked.add(imagePath);
  updateTracker();

  // Add to gallery when new
  if (wasNew) {
    const grid = document.getElementById("galleryGrid");
    if (grid) {
      const img = document.createElement("img");
      img.src = imagePath;
      img.alt = "Memory";
      img.loading = "lazy";
      grid.appendChild(img);
    }
  }
}

// Album toggle
function bindAlbumToggle() {
  const btn = document.getElementById("toggleGallery");
  const gallery = document.getElementById("gallery");
  if (!btn || !gallery) return;
  btn.addEventListener("click", () => {
    gallery.classList.toggle("hidden");
    if (!gallery.classList.contains("hidden")) {
      gallery.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
}

// Defensive binding/init
(function initGacha() {
  function bind() {
    const btn = document.getElementById("gachaButton");
    if (btn) {
      btn.removeEventListener("click", onDraw);
      btn.addEventListener("click", onDraw);
    }
    bindAlbumToggle();
    updateTracker();
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bind, { once: true });
  } else {
    bind();
  }
})();
